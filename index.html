<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tessenger</title>
    <style>
        :root { --blue: #0084ff; --bg: #ffffff; --gray: #f0f2f5; --text: #050505; --red: #fa3c4c; --green: #31a24c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; color: var(--text); }
        
        /* --- UTILITAIRES --- */
        .hidden { display: none !important; }
        .hidden-fade { opacity: 0; pointer-events: none; }
        button { cursor: pointer; border: none; outline: none; }
        
        /* --- ECRAN DE CONNEXION --- */
        #view-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; transition: opacity 0.3s; }
        .login-logo { width: 80px; margin-bottom: 20px; }
        .login-title { font-size: 24px; font-weight: 700; margin-bottom: 40px; text-align: center; background: -webkit-linear-gradient(45deg, #0099ff, #a033ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .login-input { width: 100%; max-width: 350px; padding: 15px; border: 1px solid #ddd; border-radius: 12px; background: #f0f2f5; font-size: 16px; margin-bottom: 15px; text-align: center; }
        .btn-primary { width: 100%; max-width: 350px; padding: 14px; background: var(--blue); color: white; border-radius: 30px; font-weight: bold; font-size: 16px; transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        /* --- HEADER & LISTE --- */
        .header { background: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; height: 60px; border-bottom: 1px solid #eee; z-index: 10; }
        .header-title { font-weight: 700; font-size: 24px; color: var(--text); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; }
        
        #view-list { height: 100%; display: flex; flex-direction: column; }
        .search-bar { padding: 10px 15px; }
        .search-input { width: 100%; background: var(--gray); border: none; padding: 10px 15px; border-radius: 20px; font-size: 15px; outline: none; }
        
        #contact-list { flex: 1; overflow-y: auto; }
        .contact-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; position: relative; }
        .contact-item:active { background: #f2f2f2; }
        .contact-info { flex: 1; min-width: 0; }
        .name { font-weight: 600; font-size: 16px; }
        .last-msg { font-size: 14px; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .last-msg.unread { font-weight: 700; color: var(--text); }
        
        .badge-new { background: var(--blue); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: middle; margin-left: 5px; }
        .badge-count { background: var(--red); color: white; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; padding: 0 4px; }

        /* --- CHAT VIEW --- */
        #view-chat { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        #view-chat.active { transform: translateX(0); }
        
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; background: white; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 5px; max-width: 100%; }
        .msg-bubble { padding: 8px 12px; border-radius: 18px; font-size: 15px; word-wrap: break-word; max-width: 70vw; }
        .msg-row.sent { justify-content: flex-end; }
        .msg-row.sent .msg-bubble { background: var(--blue); color: white; border-bottom-right-radius: 4px; }
        .msg-row.received .msg-bubble { background: var(--gray); color: black; border-bottom-left-radius: 4px; }
        .msg-bubble img, .msg-bubble video { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }
        .sender-name-small { font-size: 11px; color: #888; margin-left: 12px; margin-bottom: 2px; }

        .input-area { border-top: 1px solid #eee; padding: 8px 10px; display: flex; align-items: center; gap: 10px; background: white; }
        .action-icon { font-size: 24px; color: var(--blue); cursor: pointer; padding: 5px; }
        .input-text { flex: 1; background: var(--gray); border: none; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 16px; }

        /* --- MODALES (Custom UI) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 350px; border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.2s; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .modal-input { width: 100%; padding: 12px; background: #f0f2f5; border: 1px solid transparent; border-radius: 8px; margin-bottom: 15px; font-size: 15px; outline: none; }
        .modal-input:focus { border-color: var(--blue); background: white; }
        .modal-btns { display: flex; gap: 10px; }
        .btn-modal { flex: 1; padding: 10px; border-radius: 8px; font-weight: 600; font-size: 14px; }
        .btn-cancel { background: #eee; color: black; }
        .btn-confirm { background: var(--blue); color: white; }
        
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* FAB (Floating Action Button) */
        .fab { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background: var(--blue); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,132,255,0.4); cursor: pointer; z-index: 100; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }
        
        /* Menu Actions FAB */
        .fab-menu { position: fixed; bottom: 90px; right: 25px; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; z-index: 99; }
        .fab-item { background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transform: translateY(20px); opacity: 0; transition: 0.2s; pointer-events: none; }
        .fab-menu.show .fab-item { transform: translateY(0); opacity: 1; pointer-events: all; }

        /* Menu de chat contextuel */
        .chat-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 5000; display: flex; align-items: flex-end; transition: opacity 0.2s; }
        .chat-menu-box { width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 20px; animation: slideUp 0.3s; }
        .chat-menu-item { padding: 15px; font-size: 16px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; color: var(--text); }
        .chat-menu-item.danger { color: var(--red); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="view-login">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/be/Facebook_Messenger_logo_2020.svg/2048px-Facebook_Messenger_logo_2020.svg.png" class="login-logo">
        <div class="login-title">Tessenger</div>
        <input type="text" id="login-username" class="login-input" placeholder="Choisissez un pseudo" autocomplete="off">
        <input type="tel" id="login-input" class="login-input" placeholder="ID Unique (ex: mika77)" autocomplete="off">
        <button class="btn-primary" onclick="doLogin()">CONTINUER</button>
        <div id="login-error" style="color:red; margin-top:10px; font-size:13px;"></div>
    </div>

    <div id="view-list" class="hidden">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <label for="profile-upload">
                    <img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                </label>
                <input type="file" id="profile-upload" class="hidden" accept="image/*">
                <span class="header-title">Discussions</span>
            </div>
            <div style="font-size: 12px; color:#888;">ID: <span id="my-id-display"></span></div>
        </div>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Rechercher..." onkeyup="filterContacts(this.value)">
        </div>
        
        <div id="contact-list"></div>

        <div class="fab-menu" id="fab-menu">
            <div class="fab-item" onclick="openModal('group')">Nouveau Groupe üë•</div>
            <div class="fab-item" onclick="openModal('contact')">Ajouter Contact üë§</div>
        </div>
        <div class="fab" onclick="toggleFab()">+</div>
    </div>

    <div id="view-chat">
        <div class="header">
            <button onclick="closeChat()" style="color:var(--blue); background:none; font-size:24px; margin-right: 5px;">‚Üê</button>
            <div style="display:flex; align-items:center; gap:10px; flex: 1; overflow: hidden;">
                <img id="chat-avatar" class="avatar" style="width:36px; height:36px;" src="">
                <div style="display:flex; flex-direction:column; min-width: 0;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span id="chat-title" style="font-weight: 700; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
                    </div>
                </div>
            </div>
            <span style="font-size:24px; color:var(--blue); padding: 5px; cursor:pointer;" onclick="openChatMenu()">‚ãÆ</span>
        </div>

        <div id="messages"></div>
        <div id="blocked-banner" class="hidden" style="padding:15px; text-align:center; background:#ffebee; color:#c62828; font-weight:bold; border-top:1px solid #ffcdd2;">Conversation bloqu√©e</div>

        <div class="input-area" id="input-controls">
            <label for="media-upload" class="action-icon">üñºÔ∏è</label>
            <input type="file" id="media-upload" class="hidden" accept="image/*,video/*">
            <input type="text" id="msgInput" class="input-text" placeholder="Aa" onkeypress="if(event.key==='Enter') sendMessage()">
            <span class="action-icon" onclick="sendMessage()">‚û§</span>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-box">
            <div id="modal-title" class="modal-title">Titre</div>
            <input type="text" id="modal-input" class="modal-input" placeholder="...">
            <input type="text" id="modal-input-2" class="modal-input hidden" placeholder="...">
            <div id="modal-error" style="color:red; font-size:12px; margin-bottom:10px; text-align:center;"></div>
            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="closeModal()">Annuler</button>
                <button id="modal-confirm-btn" class="btn-modal btn-confirm">Valider</button>
            </div>
        </div>
    </div>

    <div id="chat-menu-overlay" class="chat-menu-overlay hidden" onclick="closeChatMenu()">
        <div class="chat-menu-box" onclick="event.stopPropagation()">
            <div class="chat-menu-item" onclick="openModal('renameLocal')">‚úèÔ∏è Renommer (localement)</div>
            <div id="block-menu-btn" class="chat-menu-item" onclick="handleBlockToggle()">üö´ Bloquer</div>
            <div class="chat-menu-item danger" onclick="confirmDeleteChat()">üóëÔ∏è Supprimer la discussion</div>
            <div class="chat-menu-item" onclick="closeChatMenu()" style="justify-content:center; color:#888; border:none;">Fermer</div>
        </div>
    </div>

<script type="module">
    
    const manifest = {
        "name": "Tessenger", "short_name": "Tessenger", "start_url": window.location.href,
        "display": "standalone", "background_color": "#e7ebf0", "theme_color": "#0088cc",
        "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/5968/5968771.png", "sizes": "192x192", "type": "image/png"}]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const link = document.createElement('link'); link.rel = 'manifest'; link.href = URL.createObjectURL(blob);
    document.head.appendChild(link);

    const swCode = `self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request)));`;
    if ('serviceWorker' in navigator) navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], {type: 'text/javascript'})));

    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAHZTBnuW-2RStrryJVqxWJ1tpD4LLaeq8",
        authDomain: "messenger-ed88b.firebaseapp.com",
        projectId: "messenger-ed88b",
        storageBucket: "messenger-ed88b.firebasestorage.app",
        messagingSenderId: "625422257839",
        appId: "1:625422257839:web:a85ce9402d2ae58cc9ce5a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let myId = localStorage.getItem('tess_user');
    let currentChatId = null; 
    let isGroupChat = false;
    let globalMessages = [];
    let usersCache = {};
    let groupsCache = {};
    
    window.doLogin = async () => {
        const idInput = document.getElementById('login-input');
        const nameInput = document.getElementById('login-username');
        const id = idInput.value.trim().toLowerCase();
        const username = nameInput.value.trim();
        
        if (id.length < 3 || username.length < 2) {
            document.getElementById('login-error').innerText = "L'ID (min 3) et le Pseudo (min 2) sont requis.";
            return;
        }

        myId = id;
        localStorage.setItem('tess_user', myId);
        await setDoc(doc(db, "users", myId), { 
            username: username,
            avatar: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
            blockedUsers: [],
            lastActive: Date.now()
        }, { merge: true });

        location.reload();
    };

    async function init() {
        if (myId) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-list').classList.remove('hidden');
            document.getElementById('my-id-display').innerText = myId;
            setupListeners();
        }
    }

    function setupListeners() {
        onSnapshot(collection(db, "users"), (snap) => {
            snap.forEach(d => usersCache[d.id] = d.data());
            if(usersCache[myId]) document.getElementById('my-avatar').src = usersCache[myId].avatar;
            renderContactList();
        });

        const qGroups = query(collection(db, "groups"), where("members", "array-contains", myId));
        onSnapshot(qGroups, (snap) => {
            groupsCache = {};
            snap.forEach(d => groupsCache[d.id] = d.data());
            renderContactList();
        });

        const qMsg = query(collection(db, "messages"), orderBy("timestamp", "desc"));
        onSnapshot(qMsg, (snap) => {
            globalMessages = [];
            snap.forEach(d => {
                const data = d.data();
                data.id = d.id;
                if (data.sender === myId || data.receiver === myId || (data.groupId && groupsCache[data.groupId])) {
                    globalMessages.push(data);
                }
            });
            renderContactList();
            if(currentChatId) renderMessages();
        });
    }

    window.toggleFab = () => document.getElementById('fab-menu').classList.toggle('show');

    // --- LOGIQUE MODALES ET ACTIONS ---
    window.openModal = (type) => {
        const overlay = document.getElementById('modal-overlay');
        const title = document.getElementById('modal-title');
        const inp1 = document.getElementById('modal-input');
        const inp2 = document.getElementById('modal-input-2');
        const btn = document.getElementById('modal-confirm-btn');
        
        overlay.classList.remove('hidden');
        inp2.classList.add('hidden');
        inp1.value = "";
        closeChatMenu();

        if(type === 'contact') {
            title.innerText = "Ajouter un contact";
            inp1.placeholder = "ID du contact";
            btn.onclick = async () => {
                const targetId = inp1.value.trim().toLowerCase();
                const docSnap = await getDoc(doc(db, "users", targetId));
                if(!docSnap.exists()) { alert("ID inexistant"); return; }
                let contacts = JSON.parse(localStorage.getItem('tess_contacts') || '{}');
                contacts[targetId] = { id: targetId, type: 'user' };
                localStorage.setItem('tess_contacts', JSON.stringify(contacts));
                renderContactList(); closeModal();
            };
        } else if(type === 'renameLocal') {
            title.innerText = "Changer le surnom";
            inp1.placeholder = "Nouveau surnom...";
            btn.onclick = () => {
                let nicks = JSON.parse(localStorage.getItem('tess_nicknames') || '{}');
                if(inp1.value.trim()) nicks[currentChatId] = inp1.value.trim();
                localStorage.setItem('tess_nicknames', JSON.stringify(nicks));
                renderContactList(); closeModal();
                if(currentChatId) document.getElementById('chat-title').innerText = inp1.value.trim();
            };
        } else if(type === 'group') {
            title.innerText = "Nouveau Groupe";
            inp1.placeholder = "Nom du groupe";
            inp2.classList.remove('hidden');
            inp2.placeholder = "Membres (ID1, ID2...)";
            btn.onclick = async () => {
                const members = [myId, ...inp2.value.split(',').map(m => m.trim())];
                await addDoc(collection(db, "groups"), { name: inp1.value, members, createdBy: myId, avatar: "https://cdn-icons-png.flaticon.com/512/166/166258.png" });
                closeModal();
            };
        }
    };

    window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');

    window.openChatMenu = () => {
        if(isGroupChat) document.getElementById('block-menu-btn').classList.add('hidden');
        else {
            document.getElementById('block-menu-btn').classList.remove('hidden');
            const isBlocked = (usersCache[myId].blockedUsers || []).includes(currentChatId);
            document.getElementById('block-menu-btn').innerText = isBlocked ? "üîì D√©bloquer" : "üö´ Bloquer";
        }
        document.getElementById('chat-menu-overlay').classList.remove('hidden');
    };
    window.closeChatMenu = () => document.getElementById('chat-menu-overlay').classList.add('hidden');

    window.handleBlockToggle = async () => {
        let blocked = usersCache[myId].blockedUsers || [];
        const isBlocked = blocked.includes(currentChatId);
        if(confirm(isBlocked ? "D√©bloquer ?" : "Bloquer ?")) {
            if(isBlocked) blocked = blocked.filter(id => id !== currentChatId);
            else blocked.push(currentChatId);
            await updateDoc(doc(db, "users", myId), { blockedUsers: blocked });
            closeChatMenu(); renderMessages();
        }
    };

    window.confirmDeleteChat = () => {
        if(confirm("Masquer cette discussion de votre liste ?")) {
            let hidden = JSON.parse(localStorage.getItem('tess_hidden') || '[]');
            if(!hidden.includes(currentChatId)) hidden.push(currentChatId);
            localStorage.setItem('tess_hidden', JSON.stringify(hidden));
            
            let c = JSON.parse(localStorage.getItem('tess_contacts') || '{}');
            delete c[currentChatId];
            localStorage.setItem('tess_contacts', JSON.stringify(c));
            
            closeChat(); renderContactList(); closeChatMenu();
        }
    };

    // --- LISTE ET CHAT ---
    window.renderContactList = () => {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        const contacts = JSON.parse(localStorage.getItem('tess_contacts') || '{}');
        const nicknames = JSON.parse(localStorage.getItem('tess_nicknames') || '{}');
        const hidden = JSON.parse(localStorage.getItem('tess_hidden') || '[]');
        let items = [];

        for(let gId in groupsCache) {
            if(!hidden.includes(gId)) items.push({ id: gId, name: nicknames[gId] || groupsCache[gId].name, type: 'group', avatar: groupsCache[gId].avatar });
        }
        for(let cId in contacts) {
            if(!hidden.includes(cId)) items.push({ id: cId, name: nicknames[cId] || usersCache[cId]?.username || cId, type: 'user', avatar: usersCache[cId]?.avatar });
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = "contact-item";
            div.onclick = () => openChat(item);
            div.innerHTML = `<img src="${item.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="avatar"><div class="contact-info"><div class="name">${item.name}</div></div>`;
            list.appendChild(div);
        });
    };

    window.openChat = (item) => {
        currentChatId = item.id;
        isGroupChat = item.type === 'group';
        const nicknames = JSON.parse(localStorage.getItem('tess_nicknames') || '{}');
        document.getElementById('view-chat').classList.add('active');
        document.getElementById('chat-title').innerText = nicknames[item.id] || item.name;
        document.getElementById('chat-avatar').src = item.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        renderMessages();
    };

    window.closeChat = () => { document.getElementById('view-chat').classList.remove('active'); currentChatId = null; };

    function renderMessages() {
        const box = document.getElementById('messages');
        box.innerHTML = "";
        const myBlocked = usersCache[myId]?.blockedUsers || [];
        const otherBlocked = usersCache[currentChatId]?.blockedUsers || [];
        const isBlocked = !isGroupChat && (myBlocked.includes(currentChatId) || otherBlocked.includes(myId));

        document.getElementById('input-controls').classList.toggle('hidden', isBlocked);
        document.getElementById('blocked-banner').classList.toggle('hidden', !isBlocked);

        const msgs = globalMessages.filter(m => {
            if(isGroupChat) return m.groupId === currentChatId;
            return (m.sender === myId && m.receiver === currentChatId) || (m.sender === currentChatId && m.receiver === myId);
        }).sort((a,b) => a.timestamp - b.timestamp);

        msgs.forEach(m => {
            const isMe = m.sender === myId;
            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'sent' : 'received'}`;
            let content = m.type === 'text' ? m.text : `<${m.type==='img'?'img':'video'} src="${m.media}" controls></${m.type==='img'?'img':'video'}>`;
            div.innerHTML = `<div class="msg-bubble">${content}</div>`;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    window.sendMessage = async () => {
        const inp = document.getElementById('msgInput');
        if(!inp.value.trim()) return;
        const data = { sender: myId, text: inp.value, timestamp: Date.now(), type: 'text' };
        if(isGroupChat) data.groupId = currentChatId; else data.receiver = currentChatId;
        inp.value = "";
        await addDoc(collection(db, "messages"), data);
    };

    window.filterContacts = (v) => {
        Array.from(document.getElementById('contact-list').children).forEach(c => {
            c.style.display = c.innerText.toLowerCase().includes(v.toLowerCase()) ? 'flex' : 'none';
        });
    };

    init();
</script>
</body>
</html>
