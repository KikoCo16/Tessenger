<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tessenger</title>
    <style>
        :root { --blue: #0084ff; --bg: #ffffff; --gray: #f0f2f5; --text: #050505; --red: #fa3c4c; --green: #31a24c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; color: var(--text); }
        
        .hidden { display: none !important; }
        button { cursor: pointer; border: none; outline: none; transition: 0.2s; }
        
        /* --- CONNEXION --- */
        #view-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .login-logo { width: 80px; margin-bottom: 20px; }
        .login-title { font-size: 24px; font-weight: 700; margin-bottom: 30px; background: linear-gradient(45deg, #0099ff, #a033ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .login-input { width: 100%; max-width: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 12px; background: #f0f2f5; font-size: 16px; margin-bottom: 12px; text-align: center; }
        .btn-primary { width: 100%; max-width: 300px; padding: 14px; background: var(--blue); color: white; border-radius: 30px; font-weight: bold; font-size: 16px; }

        /* --- HEADER & LISTE --- */
        .header { background: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; height: 65px; border-bottom: 1px solid #eee; position: sticky; top: 0; }
        .header-title { font-weight: 800; font-size: 26px; }
        .avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; border: 1px solid #eee; }
        
        #view-list { height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .search-bar { padding: 10px 15px; }
        .search-input { width: 100%; background: var(--gray); border: none; padding: 12px 18px; border-radius: 25px; font-size: 15px; }
        
        #contact-list { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .contact-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; position: relative; }
        .contact-item:active { background: #f2f2f2; }
        .contact-info { flex: 1; min-width: 0; }
        .name { font-weight: 600; font-size: 16px; margin-bottom: 2px; }
        .last-msg { font-size: 14px; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .last-msg.unread { font-weight: 700; color: var(--text); }
        .badge-count { background: var(--red); color: white; min-width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; padding: 0 4px; }

        /* --- CHAT VIEW --- */
        #view-chat { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #view-chat.active { transform: translateX(0); }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        
        .msg-row { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 2px; }
        .msg-bubble { padding: 8px 14px; border-radius: 20px; font-size: 15px; max-width: 75vw; position: relative; line-height: 1.4; }
        .msg-row.sent { justify-content: flex-end; }
        .msg-row.sent .msg-bubble { background: var(--blue); color: white; border-bottom-right-radius: 4px; }
        .msg-row.received .msg-bubble { background: var(--gray); color: black; border-bottom-left-radius: 4px; }
        .msg-bubble img, .msg-bubble video { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }
        .sender-name { font-size: 11px; color: #888; margin-left: 10px; margin-bottom: 2px; }

        .input-area { border-top: 1px solid #eee; padding: 10px; display: flex; align-items: center; gap: 12px; background: white; }
        .input-text { flex: 1; background: var(--gray); border: none; padding: 12px 18px; border-radius: 25px; font-size: 16px; outline: none; }

        /* --- MODALES & MENUS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 350px; border-radius: 20px; padding: 25px; animation: pop 0.2s; }
        .modal-title { font-size: 19px; font-weight: 700; text-align: center; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 14px; background: #f0f2f5; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; font-size: 16px; }
        .modal-btns { display: flex; gap: 10px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 10px; font-weight: bold; }
        
        .chat-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 5000; display: flex; align-items: flex-end; }
        .chat-menu-box { width: 100%; background: white; border-radius: 25px 25px 0 0; padding: 20px; transform: translateY(0); animation: slideUp 0.3s; }
        .chat-menu-item { padding: 16px; font-size: 17px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; }
        .chat-menu-item.danger { color: var(--red); }

        /* FAB */
        .fab { position: fixed; bottom: 25px; right: 25px; width: 56px; height: 56px; background: var(--blue); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 5px 15px rgba(0,132,255,0.4); z-index: 100; }
        .fab-menu { position: fixed; bottom: 95px; right: 25px; display: flex; flex-direction: column; gap: 12px; z-index: 99; transition: 0.3s; pointer-events: none; opacity: 0; transform: translateY(20px); }
        .fab-menu.show { opacity: 1; transform: translateY(0); pointer-events: all; }
        .fab-item { background: white; padding: 10px 20px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 600; display: flex; align-items: center; gap: 10px; }

        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="view-login">
    <img src="https://cdn-icons-png.flaticon.com/512/5968/5968771.png" class="login-logo">
    <div class="login-title">Tessenger</div>
    <input type="text" id="login-username" class="login-input" placeholder="Pseudo" autocomplete="off">
    <input type="number" id="login-id" class="login-input" placeholder="ID (3 √† 5 chiffres)" autocomplete="off">
    <input type="password" id="login-pw" class="login-input" placeholder="Mot de passe">
    
    <button class="btn-primary" onclick="doLogin()">CONNEXION</button>
    <div id="login-error" style="color:red; font-size:13px; margin-top:10px; max-width: 250px; text-align: center;"></div>
</div>


    <div id="view-list" class="hidden">
        <div class="header">
    <div style="display: flex; align-items: center; gap: 15px;">
        <label for="profile-upload">
            <img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
        </label>
        <input type="file" id="profile-upload" class="hidden" accept="image/*">
        <div>
            <div class="header-title" id="header-user-name">Discussions</div>

            <div id="display-my-id" style="font-size: 12px; color: #888; font-weight: 500;">ID: ----</div>
        </div>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
        <button onclick="toggleSettings()" style="background:none; font-size: 20px;">üîî</button>
        <button onclick="hardReset()" style="color:#aaa; background:none; font-size:11px; font-weight:bold;">D√âCONNEXION</button>
    </div>
</div>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Rechercher..." onkeyup="filterContacts(this.value)">
        </div>
        <div id="contact-list"></div>
        <div class="fab-menu" id="fab-menu">
            <div class="fab-item" onclick="openModal('group')">Nouveau Groupe üë•</div>
            <div class="fab-item" onclick="openModal('contact')">Ajouter un ID üë§</div>
        </div>
        <div class="fab" onclick="toggleFab()">+</div>
    </div>

    <div id="view-chat">
        <div class="header">
            <button onclick="closeChat()" style="color:var(--blue); background:none; font-size:28px;">‚Üê</button>
            <div style="display:flex; align-items:center; gap:12px; flex: 1; overflow: hidden;">
                <img id="chat-avatar" class="avatar" style="width:38px; height:38px;">
                <span id="chat-title" style="font-weight: 700; font-size: 17px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
            </div>
            <span style="font-size:26px; color:var(--blue); padding: 5px;" onclick="openChatMenu()">‚ãÆ</span>
        </div>
        <div id="messages"></div>
        <div id="blocked-banner" class="hidden" style="padding:15px; text-align:center; background:#ffebee; color:var(--red); font-weight:bold;">Conversation Bloqu√©e</div>
        <div class="input-area" id="input-controls">
            <label for="media-upload" style="font-size:26px; cursor:pointer;">üñºÔ∏è</label>
            <input type="file" id="media-upload" class="hidden" accept="image/*,video/*">
            <input type="text" id="msgInput" class="input-text" placeholder="Aa" onkeypress="if(event.key==='Enter') sendMessage()">
            <span style="font-size:26px; color:var(--blue);" onclick="sendMessage()">‚û§</span>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-box">
            <div id="modal-title" class="modal-title"></div>
            <input type="text" id="modal-input" class="modal-input" autocomplete="off">
            <input type="text" id="modal-input-2" class="modal-input hidden" placeholder="ID des membres (ex: 123, 456)" autocomplete="off">
            <div id="modal-error" style="color:red; font-size:12px; text-align:center; margin-bottom:10px;"></div>
            <div class="modal-btns">
                <button class="btn-modal" onclick="closeModal()" style="background:#eee;">Annuler</button>
                <button id="modal-confirm-btn" class="btn-modal" style="background:var(--blue); color:white;">Valider</button>
            </div>
        </div>
    </div>

    <div id="chat-menu-overlay" class="chat-menu-overlay hidden" onclick="closeChatMenu()">
        <div class="chat-menu-box" onclick="event.stopPropagation()">
            <div class="chat-menu-item" onclick="openModal('renameLocal')">‚úèÔ∏è Renommer localement</div>
            <div id="block-menu-btn" class="chat-menu-item" onclick="handleBlockToggle()">üö´ Bloquer l'utilisateur</div>
            <div class="chat-menu-item danger" onclick="confirmDeleteChat()">üóëÔ∏è Supprimer la discussion</div>
            <div class="chat-menu-item" onclick="closeChatMenu()" style="justify-content:center; color:#888; border:none; margin-top:10px;">Fermer</div>
        </div>
    </div>

<script type="module">
    
    const manifest = {
        "name": "Tessenger", "short_name": "Tessenger", "start_url": window.location.href,
        "display": "standalone", "background_color": "#e7ebf0", "theme_color": "#0088cc",
        "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/5968/5968771.png", "sizes": "192x192", "type": "image/png"}]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const link = document.createElement('link'); link.rel = 'manifest'; link.href = URL.createObjectURL(blob);
    document.head.appendChild(link);

    const swCode = `self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request)));`;
    if ('serviceWorker' in navigator) navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], {type: 'text/javascript'})));

    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAHZTBnuW-2RStrryJVqxWJ1tpD4LLaeq8",
        authDomain: "messenger-ed88b.firebaseapp.com",
        projectId: "messenger-ed88b",
        storageBucket: "messenger-ed88b.firebasestorage.app",
        messagingSenderId: "625422257839",
        appId: "1:625422257839:web:a85ce9402d2ae58cc9ce5a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let myId = localStorage.getItem('tess_user');
    let currentChatId = null; 
    let isGroupChat = false;
    let globalMessages = [];
    let usersCache = {};
    let groupsCache = {};

    window.hardReset = () => { if(confirm("√âTES VOUS SUR DE VOULOIR VOUS D√âCONNECTER?")) { localStorage.clear(); location.reload(); } };

    window.doLogin = async () => {
    const id = document.getElementById('login-id').value.trim();
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-pw').value.trim();
    const err = document.getElementById('login-error');

    // Validations de base
    if (id.length < 3 || id.length > 5 || isNaN(id)) { err.innerText = "L'ID doit faire 3 √† 5 chiffres."; return; }
    if (username.length < 2) { err.innerText = "Pseudo trop court."; return; }
    if (password.length < 4) { err.innerText = "Le mot de passe doit faire au moins 4 caract√®res."; return; }

    try {
        const userDocRef = doc(db, "users", id);
        const userSnap = await getDoc(userDocRef);

        if (userSnap.exists()) {
            // L'utilisateur existe, on v√©rifie le mot de passe
            const userData = userSnap.data();
            if (userData.password === password) {
                // Succ√®s : Mot de passe correct
                myId = id;
                localStorage.setItem('tess_user', myId);
                location.reload();
            } else {
                // Erreur : Mauvais mot de passe
                err.innerText = "ID d√©j√† utilis√©. Mot de passe incorrect.";
            }
        } else {
            // Premier enregistrement : On cr√©e l'utilisateur avec son mot de passe
            myId = id;
            localStorage.setItem('tess_user', myId);
            await setDoc(userDocRef, { 
                username: username,
                password: password, // Stockage du mot de passe
                avatar: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
                blockedUsers: [],
                lastActive: Date.now()
            });
            location.reload();
        }
    } catch (e) {
        console.error(e);
        err.innerText = "Erreur de connexion au serveur.";
    }
};


    async function init() {
    if (myId) {
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-list').classList.remove('hidden');
        document.getElementById('display-my-id').innerText = "ID: " + myId;

        // --- AJOUT : Affiche le pseudo s'il est d√©j√† en cache ---
        const savedName = localStorage.getItem('tess_user_name');
        if(savedName) {
            document.getElementById('header-user-name').innerText = savedName;
        }
        
        setupListeners();
    }
}

    function setupListeners() {
    // Variable pour √©viter de notifier les anciens messages au d√©marrage
    let lastMsgTimestamp = Date.now();

    // 1. Listener pour les UTILISATEURS
    onSnapshot(collection(db, "users"), (snap) => {
        snap.forEach(d => usersCache[d.id] = d.data());
        
        if (usersCache[myId]) {
            // Met √† jour l'avatar
            document.getElementById('my-avatar').src = usersCache[myId].avatar;
            
            // REMPLACE "Discussions" par ton PSEUDO
            const username = usersCache[myId].username;
            const headerTitle = document.getElementById('header-user-name');
            if (headerTitle) {
                headerTitle.innerText = username;
            }
            // Sauvegarde locale pour un chargement instantan√© au prochain refresh
            localStorage.setItem('tess_user_name', username);
        }
        renderContactList();
    });

    // 2. Listener pour les GROUPES
    onSnapshot(query(collection(db, "groups"), where("members", "array-contains", myId)), (snap) => {
        groupsCache = {};
        snap.forEach(d => groupsCache[d.id] = {id: d.id, ...d.data()});
        renderContactList();
    });

    // 3. Listener pour les MESSAGES (Notifications + Affichage)
    onSnapshot(query(collection(db, "messages"), orderBy("timestamp", "desc")), (snap) => {
        globalMessages = [];
        let newMessageToNotify = null;

        snap.forEach(d => {
            const data = d.data();
            // Filtrer les messages qui me concernent
            if (data.sender === myId || data.receiver === myId || (data.groupId && groupsCache[data.groupId])) {
                globalMessages.push(data);

                // V√©rifier si c'est un nouveau message re√ßu (pas envoy√© par moi)
                if (data.timestamp > lastMsgTimestamp && data.sender !== myId) {
                    newMessageToNotify = data;
                }
            }
        });

        // D√©clencher la notification si un nouveau message arrive
        if (newMessageToNotify) {
            showNotification(newMessageToNotify);
            // On met √† jour le curseur pour ne pas notifier deux fois le m√™me message
            lastMsgTimestamp = newMessageToNotify.timestamp;
        }

        renderContactList();
        if (currentChatId) renderMessages();
    });
}



    function getUnreadCount(chatId) {
        const lastRead = parseInt(localStorage.getItem('read_' + chatId) || '0');
        return globalMessages.filter(m => {
            const incoming = m.sender !== myId;
            const belongs = m.groupId === chatId || (m.sender === chatId && !m.groupId);
            return belongs && incoming && m.timestamp > lastRead;
        }).length;
    }
    
    // √âtat des notifications (charg√© depuis le localStorage)
let notificationsEnabled = localStorage.getItem('tess_notifs') === 'true';

window.toggleSettings = async () => {
    if (!notificationsEnabled) {
        // Demander la permission si on veut les activer
        const permission = await Notification.requestPermission();
        if (permission === "granted") {
            notificationsEnabled = true;
            alert("Notifications activ√©es !");
        } else {
            alert("Permission refus√©e par le navigateur.");
            notificationsEnabled = false;
        }
    } else {
        notificationsEnabled = false;
        alert("Notifications d√©sactiv√©es.");
    }
    localStorage.setItem('tess_notifs', notificationsEnabled);
};

    
    function showNotification(msgData) {
    if (!notificationsEnabled || document.visibilityState === 'visible') return;
    if (msgData.sender === myId) return;

    // R√©cup√©rer le nom de l'exp√©diteur
    const senderName = usersCache[msgData.sender]?.username || msgData.sender;
    const content = msgData.type === 'text' ? msgData.text : "üì∑ Image ou Vid√©o";

    const notif = new Notification(`Nouveau message de ${senderName}`, {
        body: content,
        icon: usersCache[msgData.sender]?.avatar || 'https://cdn-icons-png.flaticon.com/512/5968/5968771.png'
    });

    notif.onclick = () => {
        window.focus();
        // Optionnel : ouvrir le chat directement
        const contact = { id: msgData.groupId || msgData.sender, type: msgData.groupId ? 'group' : 'user', name: senderName };
        openChat(contact);
    };
}


    function getLastMsg(chatId, isG) {
        const m = globalMessages.find(msg => isG ? msg.groupId === chatId : (msg.sender === chatId || msg.receiver === chatId));
        if(!m) return "Aucun message";
        const pre = m.sender === myId ? "Vous: " : "";
        return pre + (m.type === 'text' ? m.text : (m.type === 'img' ? "üì∏ Photo" : "üé• Vid√©o"));
    }

    window.renderContactList = () => {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        const nicks = JSON.parse(localStorage.getItem('tess_nicks') || '{}');
        const hidden = JSON.parse(localStorage.getItem('tess_hide') || '[]');
        let items = [];
        for(let gId in groupsCache) if(!hidden.includes(gId)) items.push({ id: gId, name: nicks[gId] || groupsCache[gId].name, type: 'group', avatar: groupsCache[gId].avatar });
        let contacts = JSON.parse(localStorage.getItem('tess_contacts') || '{}');
        globalMessages.forEach(m => { if(!m.groupId && m.sender !== myId) contacts[m.sender] = {id: m.sender, type:'user'}; });
        for(let cId in contacts) if(!hidden.includes(cId) && cId !== myId) items.push({ id: cId, name: nicks[cId] || usersCache[cId]?.username || cId, type: 'user', avatar: usersCache[cId]?.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png" });
        items.sort((a,b) => (globalMessages.find(m => b.type==='group'?m.groupId===b.id:(m.sender===b.id||m.receiver===b.id))?.timestamp||0) - (globalMessages.find(m => a.type==='group'?m.groupId===a.id:(m.sender===a.id||m.receiver===a.id))?.timestamp||0));
        items = Array.from(new Map(items.map(i => [i.id, i])).values());
        items.forEach(item => {
            const unread = getUnreadCount(item.id);
            const div = document.createElement('div');
            div.className = "contact-item";
            div.onclick = () => openChat(item);
            div.innerHTML = `<img src="${item.avatar}" class="avatar"><div class="contact-info"><div class="name">${item.name}</div><div class="last-msg ${unread > 0 ? 'unread' : ''}">${getLastMsg(item.id, item.type==='group')}</div></div>${unread > 0 ? `<div class="badge-count">${unread}</div>` : ''}`;
            list.appendChild(div);
        });
    };

    window.openChat = (item) => {
        currentChatId = item.id; isGroupChat = item.type === 'group';
        document.getElementById('view-chat').classList.add('active');
        document.getElementById('chat-title').innerText = item.name;
        document.getElementById('chat-avatar').src = item.avatar;
        localStorage.setItem('read_' + currentChatId, Date.now());
        renderMessages();
    };

    window.closeChat = () => { document.getElementById('view-chat').classList.remove('active'); currentChatId = null; renderContactList(); };

    function renderMessages() {
        const box = document.getElementById('messages');
        box.innerHTML = "";
        const isBlocked = !isGroupChat && ((usersCache[myId]?.blockedUsers || []).includes(currentChatId) || (usersCache[currentChatId]?.blockedUsers || []).includes(myId));
        document.getElementById('input-controls').classList.toggle('hidden', isBlocked);
        document.getElementById('blocked-banner').classList.toggle('hidden', !isBlocked);
        const msgs = globalMessages.filter(m => isGroupChat ? m.groupId === currentChatId : (m.sender === myId && m.receiver === currentChatId) || (m.sender === currentChatId && m.receiver === myId)).sort((a,b) => a.timestamp - b.timestamp);
        msgs.forEach(m => {
            const isMe = m.sender === myId;
            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'sent' : 'received'}`;
            let content = m.type === 'text' ? `<div>${m.text}</div>` : `<${m.type==='img'?'img':'video'} src="${m.media}" ${m.type==='video'?'controls':''}></${m.type==='img'?'img':'video'}>`;
            let sender = (isGroupChat && !isMe) ? `<div class="sender-name">${usersCache[m.sender]?.username || m.sender}</div>` : "";
            div.innerHTML = `<div style="display:flex;flex-direction:column;align-items:${isMe?'flex-end':'flex-start'}">${sender}<div class="msg-bubble">${content}</div></div>`;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    window.sendMessage = async () => {
        const inp = document.getElementById('msgInput'); if(!inp.value.trim()) return;
        const data = { sender: myId, text: inp.value, timestamp: Date.now(), type: 'text' };
        if(isGroupChat) data.groupId = currentChatId; else data.receiver = currentChatId;
        inp.value = ""; await addDoc(collection(db, "messages"), data);
    };

    async function compress(base64, size = 600, quality = 0.6) {
        return new Promise(r => {
            const img = new Image(); img.src = base64;
            img.onload = () => {
                const cvs = document.createElement('canvas'); const ratio = size / Math.max(img.width, img.height);
                cvs.width = img.width * Math.min(1, ratio); cvs.height = img.height * Math.min(1, ratio);
                cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                r(cvs.toDataURL('image/jpeg', quality));
            };
        });
    }

    document.getElementById('media-upload').addEventListener('change', e => {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async evt => {
            let dataUrl = evt.target.result; const type = f.type.startsWith('image') ? 'img' : 'video';
            if(type === 'img') dataUrl = await compress(dataUrl);
            if(dataUrl.length > 950000) return alert("Fichier trop lourd !");
            const msg = { sender: myId, media: dataUrl, type, timestamp: Date.now() };
            if(isGroupChat) msg.groupId = currentChatId; else msg.receiver = currentChatId;
            await addDoc(collection(db, "messages"), msg);
        };
        reader.readAsDataURL(f);
    });

    document.getElementById('profile-upload').addEventListener('change', e => {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async evt => {
            const compressed = await compress(evt.target.result, 150, 0.5);
            await updateDoc(doc(db, "users", myId), { avatar: compressed });
        };
        reader.readAsDataURL(f);
    });

    window.openModal = (type) => {
        const ov = document.getElementById('modal-overlay'); const t = document.getElementById('modal-title');
        const i1 = document.getElementById('modal-input'); const i2 = document.getElementById('modal-input-2');
        const btn = document.getElementById('modal-confirm-btn');
        ov.classList.remove('hidden'); i2.classList.add('hidden'); i1.value = ""; document.getElementById('fab-menu').classList.remove('show');
        if(type === 'contact') {
            t.innerText = "Ajouter un ID"; i1.placeholder = "ID √† ajouter (ex: 123)";
            btn.onclick = async () => {
                const snap = await getDoc(doc(db, "users", i1.value.trim()));
                if(!snap.exists()) return alert("ID inconnu");
                let c = JSON.parse(localStorage.getItem('tess_contacts') || '{}');
                c[i1.value.trim()] = {id: i1.value.trim(), type: 'user'};
                localStorage.setItem('tess_contacts', JSON.stringify(c)); closeModal(); renderContactList();
            };
        } else if(type === 'renameLocal') {
            t.innerText = "Surnom Local"; i1.placeholder = "Nouveau nom...";
            btn.onclick = () => {
                let n = JSON.parse(localStorage.getItem('tess_nicks') || '{}');
                if(i1.value.trim()) n[currentChatId] = i1.value.trim();
                localStorage.setItem('tess_nicks', JSON.stringify(n)); closeModal(); renderContactList();
                document.getElementById('chat-title').innerText = i1.value.trim();
            };
        } else if(type === 'group') {
            t.innerText = "Cr√©er un Groupe"; i1.placeholder = "Nom du groupe"; i2.classList.remove('hidden');
            btn.onclick = async () => {
                const mems = [myId, ...i2.value.split(',').map(m => m.trim())];
                await addDoc(collection(db, "groups"), { name: i1.value, members: mems, createdBy: myId, avatar: "https://cdn-icons-png.flaticon.com/512/166/166258.png" });
                closeModal();
            };
        }
    };

    window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
    window.toggleFab = () => document.getElementById('fab-menu').classList.toggle('show');
    window.openChatMenu = () => {
        document.getElementById('block-menu-btn').innerText = (usersCache[myId]?.blockedUsers || []).includes(currentChatId) ? "üîì D√©bloquer" : "üö´ Bloquer";
        document.getElementById('chat-menu-overlay').classList.remove('hidden');
    };
    window.closeChatMenu = () => document.getElementById('chat-menu-overlay').classList.add('hidden');
    window.handleBlockToggle = async () => {
        let b = usersCache[myId].blockedUsers || [];
        b = b.includes(currentChatId) ? b.filter(id => id !== currentChatId) : [...b, currentChatId];
        await updateDoc(doc(db, "users", myId), { blockedUsers: b }); closeChatMenu(); renderMessages();
    };
    window.confirmDeleteChat = () => {
        if(confirm("Masquer ?")) {
            let h = JSON.parse(localStorage.getItem('tess_hide') || '[]');
            h.push(currentChatId); localStorage.setItem('tess_hide', JSON.stringify(h));
            closeChat(); closeChatMenu();
        }
    };
    window.filterContacts = (v) => Array.from(document.getElementById('contact-list').children).forEach(c => c.style.display = c.innerText.toLowerCase().includes(v.toLowerCase())?'flex':'none');
    init();
</script>
</body>
</html>
