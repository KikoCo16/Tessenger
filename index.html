<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tessenger</title>
    <style>
        :root { --blue: #0084ff; --bg: #ffffff; --gray: #f0f2f5; --text: #050505; --red: #fa3c4c; --green: #31a24c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; color: var(--text); }
        
        /* --- UTILITAIRES --- */
        .hidden { display: none !important; }
        .hidden-fade { opacity: 0; pointer-events: none; }
        button { cursor: pointer; border: none; outline: none; }
        
        /* --- ECRAN DE CONNEXION --- */
        #view-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; transition: opacity 0.3s; }
        .login-logo { width: 80px; margin-bottom: 20px; }
        .login-title { font-size: 24px; font-weight: 700; margin-bottom: 40px; text-align: center; background: -webkit-linear-gradient(45deg, #0099ff, #a033ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .login-input { width: 100%; max-width: 350px; padding: 15px; border: 1px solid #ddd; border-radius: 12px; background: #f0f2f5; font-size: 16px; margin-bottom: 15px; text-align: center; }
        .btn-primary { width: 100%; max-width: 350px; padding: 14px; background: var(--blue); color: white; border-radius: 30px; font-weight: bold; font-size: 16px; transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        /* --- HEADER & LISTE --- */
        .header { background: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; height: 60px; border-bottom: 1px solid #eee; z-index: 10; }
        .header-title { font-weight: 700; font-size: 24px; color: var(--text); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; }
        
        #view-list { height: 100%; display: flex; flex-direction: column; }
        .search-bar { padding: 10px 15px; }
        .search-input { width: 100%; background: var(--gray); border: none; padding: 10px 15px; border-radius: 20px; font-size: 15px; outline: none; }
        
        #contact-list { flex: 1; overflow-y: auto; }
        .contact-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; position: relative; }
        .contact-item:active { background: #f2f2f2; }
        .contact-info { flex: 1; min-width: 0; }
        .name { font-weight: 600; font-size: 16px; }
        .last-msg { font-size: 14px; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .last-msg.unread { font-weight: 700; color: var(--text); }
        
        .badge-new { background: var(--blue); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: middle; margin-left: 5px; }
        .badge-count { background: var(--red); color: white; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; padding: 0 4px; }

        /* --- CHAT VIEW --- */
        #view-chat { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        #view-chat.active { transform: translateX(0); }
        
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; background: white; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 5px; max-width: 100%; }
        .msg-bubble { padding: 8px 12px; border-radius: 18px; font-size: 15px; word-wrap: break-word; max-width: 70vw; }
        .msg-row.sent { justify-content: flex-end; }
        .msg-row.sent .msg-bubble { background: var(--blue); color: white; border-bottom-right-radius: 4px; }
        .msg-row.received .msg-bubble { background: var(--gray); color: black; border-bottom-left-radius: 4px; }
        .msg-bubble img, .msg-bubble video { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }
        .sender-name-small { font-size: 11px; color: #888; margin-left: 12px; margin-bottom: 2px; }

        .input-area { border-top: 1px solid #eee; padding: 8px 10px; display: flex; align-items: center; gap: 10px; background: white; }
        .action-icon { font-size: 24px; color: var(--blue); cursor: pointer; padding: 5px; }
        .input-text { flex: 1; background: var(--gray); border: none; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 16px; }

        /* --- MODALES (Custom UI) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 350px; border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.2s; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .modal-input { width: 100%; padding: 12px; background: #f0f2f5; border: 1px solid transparent; border-radius: 8px; margin-bottom: 15px; font-size: 15px; outline: none; }
        .modal-input:focus { border-color: var(--blue); background: white; }
        .modal-btns { display: flex; gap: 10px; }
        .btn-modal { flex: 1; padding: 10px; border-radius: 8px; font-weight: 600; font-size: 14px; }
        .btn-cancel { background: #eee; color: black; }
        .btn-confirm { background: var(--blue); color: white; }
        
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* FAB (Floating Action Button) */
        .fab { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background: var(--blue); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,132,255,0.4); cursor: pointer; z-index: 100; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }
        
        /* Menu Actions FAB */
        .fab-menu { position: fixed; bottom: 90px; right: 25px; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; z-index: 99; }
        .fab-item { background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transform: translateY(20px); opacity: 0; transition: 0.2s; pointer-events: none; }
        .fab-menu.show .fab-item { transform: translateY(0); opacity: 1; pointer-events: all; }
    </style>
</head>
<body>

    <div id="view-login">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/be/Facebook_Messenger_logo_2020.svg/2048px-Facebook_Messenger_logo_2020.svg.png" class="login-logo">
        <div class="login-title">Tessenger</div>
        <input type="tel" id="login-input" class="login-input" placeholder="Entrez votre num√©ro/ID" autocomplete="off">
        <button class="btn-primary" onclick="doLogin()">CONTINUER</button>
        <div id="login-error" style="color:red; margin-top:10px; font-size:13px;"></div>
    </div>

    <div id="view-list" class="hidden">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <label for="profile-upload">
                    <img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                </label>
                <input type="file" id="profile-upload" class="hidden" accept="image/*">
                <span class="header-title">Discussions</span>
            </div>
            <div style="font-size: 12px; color:#888;">ID: <span id="my-id-display"></span></div>
        </div>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Rechercher..." onkeyup="filterContacts(this.value)">
        </div>
        
        <div id="contact-list"></div>

        <div class="fab-menu" id="fab-menu">
            <div class="fab-item" onclick="openModal('group')">Nouveau Groupe üë•</div>
            <div class="fab-item" onclick="openModal('contact')">Ajouter Contact üë§</div>
        </div>
        <div class="fab" onclick="toggleFab()">+</div>
    </div>

    <div id="view-chat">
        <div class="header">
            <button onclick="closeChat()" style="color:var(--blue); background:none; font-size:24px; margin-right: 5px;">‚Üê</button>
            <div style="display:flex; align-items:center; gap:10px; flex: 1; overflow: hidden;">
                <img id="chat-avatar" class="avatar" style="width:36px; height:36px;" src="">
                <div style="display:flex; flex-direction:column; min-width: 0;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span id="chat-title" style="font-weight: 700; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
                        <span id="edit-group-btn" class="hidden" onclick="openModal('renameGroup')" style="font-size:14px; cursor:pointer;">‚úèÔ∏è</span>
                    </div>
                </div>
            </div>
            <span style="font-size:20px; padding: 10px;" onclick="chatActions()">‚ãÆ</span>
        </div>

        <div id="messages"></div>
        <div id="blocked-banner" class="hidden" style="padding:10px; text-align:center; background:#eee; color:#555;">Conversation bloqu√©e</div>

        <div class="input-area" id="input-controls">
            <label for="media-upload" class="action-icon">üñºÔ∏è</label>
            <input type="file" id="media-upload" class="hidden" accept="image/*,video/*">
            <input type="text" id="msgInput" class="input-text" placeholder="Aa" onkeypress="if(event.key==='Enter') sendMessage()">
            <span class="action-icon" onclick="sendMessage()">‚û§</span>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-box">
            <div id="modal-title" class="modal-title">Titre</div>
            <input type="text" id="modal-input" class="modal-input" placeholder="...">
            <input type="text" id="modal-input-2" class="modal-input hidden" placeholder="...">
            <div id="modal-error" style="color:red; font-size:12px; margin-bottom:10px; text-align:center;"></div>
            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="closeModal()">Annuler</button>
                <button id="modal-confirm-btn" class="btn-modal btn-confirm">Valider</button>
            </div>
        </div>
    </div>

<script type="module">
    
    const manifest = {
        "name": "Tessenger", "short_name": "Tessenger", "start_url": window.location.href,
        "display": "standalone", "background_color": "#e7ebf0", "theme_color": "#0088cc",
        "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/5968/5968771.png", "sizes": "192x192", "type": "image/png"}]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const link = document.createElement('link'); link.rel = 'manifest'; link.href = URL.createObjectURL(blob);
    document.head.appendChild(link);

    const swCode = `self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request)));`;
    if ('serviceWorker' in navigator) navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], {type: 'text/javascript'})));

    
    // --- SETUP FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAHZTBnuW-2RStrryJVqxWJ1tpD4LLaeq8",
        authDomain: "messenger-ed88b.firebaseapp.com",
        projectId: "messenger-ed88b",
        storageBucket: "messenger-ed88b.firebasestorage.app",
        messagingSenderId: "625422257839",
        appId: "1:625422257839:web:a85ce9402d2ae58cc9ce5a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- VARIABLES GLOBALES ---
    let myId = localStorage.getItem('tess_user');
    let currentChatId = null; 
    let isGroupChat = false;
    let globalMessages = [];
    let usersCache = {};
    let groupsCache = {};
    
    // --- AUTHENTIFICATION ---
    window.doLogin = async () => {
        const input = document.getElementById('login-input');
        const id = input.value.trim().toLowerCase();
        
        if (id.length < 3) {
            document.getElementById('login-error').innerText = "L'ID doit faire au moins 3 caract√®res.";
            return;
        }

        myId = id;
        localStorage.setItem('tess_user', myId);
        
        // Cr√©er l'utilisateur dans la base s'il n'existe pas
        await setDoc(doc(db, "users", myId), { 
            avatar: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
            lastActive: Date.now()
        }, { merge: true });

        document.getElementById('view-login').classList.add('hidden-fade');
        setTimeout(() => {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-list').classList.remove('hidden');
        }, 300);
        
        startApp();
    };

    async function init() {
        if (myId) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-list').classList.remove('hidden');
            startApp();
        }
    }

    function startApp() {
        document.getElementById('my-id-display').innerText = myId;
        setupListeners();
    }

    // --- LOGIQUE FIREBASE ---
    function setupListeners() {
        // Ecouter Users
        onSnapshot(collection(db, "users"), (snap) => {
            snap.forEach(d => usersCache[d.id] = d.data());
            if(usersCache[myId]) document.getElementById('my-avatar').src = usersCache[myId].avatar;
            renderContactList();
        });

        // Ecouter Groupes (o√π je suis membre)
        const qGroups = query(collection(db, "groups"), where("members", "array-contains", myId));
        onSnapshot(qGroups, (snap) => {
            groupsCache = {};
            snap.forEach(d => groupsCache[d.id] = d.data());
            renderContactList();
            // Si on est dans le chat d'un groupe, maj du titre instantan√©e
            if(isGroupChat && groupsCache[currentChatId]) {
                document.getElementById('chat-title').innerText = groupsCache[currentChatId].name;
            }
        });

        // Ecouter Messages
        const qMsg = query(collection(db, "messages"), orderBy("timestamp", "desc"));
        onSnapshot(qMsg, (snap) => {
            globalMessages = [];
            snap.forEach(d => {
                const data = d.data();
                data.id = d.id;
                // Filtrer localement
                const amIMember = data.sender === myId || data.receiver === myId || (data.groupId && groupsCache[data.groupId]);
                if (amIMember) globalMessages.push(data);
            });
            renderContactList();
            if(currentChatId) renderMessages();
        });
    }

    // --- GESTION MODALES & ACTIONS ---
    window.toggleFab = () => {
        document.getElementById('fab-menu').classList.toggle('show');
    };

    // Gestionnaire g√©n√©rique de modale
    window.openModal = (type) => {
        const overlay = document.getElementById('modal-overlay');
        const title = document.getElementById('modal-title');
        const inp1 = document.getElementById('modal-input');
        const inp2 = document.getElementById('modal-input-2');
        const btn = document.getElementById('modal-confirm-btn');
        const err = document.getElementById('modal-error');
        
        overlay.classList.remove('hidden');
        inp2.classList.add('hidden');
        err.innerText = "";
        inp1.value = "";
        inp2.value = "";
        document.getElementById('fab-menu').classList.remove('show');

        if(type === 'contact') {
            title.innerText = "Ajouter un contact";
            inp1.placeholder = "ID du contact";
            btn.onclick = async () => {
                const targetId = inp1.value.trim().toLowerCase();
                if(targetId === myId) { err.innerText = "C'est vous !"; return; }
                
                // VERIFICATION EXISTENCE ID
                const docSnap = await getDoc(doc(db, "users", targetId));
                if(!docSnap.exists()) {
                    err.innerText = "Cet ID n'existe pas dans Tessenger.";
                    return;
                }
                
                let contacts = JSON.parse(localStorage.getItem('tess_contacts') || '{}');
                contacts[targetId] = { name: targetId, type: 'user' };
                localStorage.setItem('tess_contacts', JSON.stringify(contacts));
                renderContactList();
                closeModal();
            };
        } 
        else if (type === 'group') {
            title.innerText = "Cr√©er un groupe";
            inp1.placeholder = "Nom du groupe";
            inp2.placeholder = "Membres (ID s√©par√©s par virgule)";
            inp2.classList.remove('hidden');
            
            btn.onclick = async () => {
                const gName = inp1.value.trim();
                const membersRaw = inp2.value.toLowerCase().split(',');
                if(!gName) { err.innerText = "Nom requis"; return; }
                
                let members = [myId];
                // V√©rifier chaque membre
                for(let m of membersRaw) {
                    let cleanM = m.trim();
                    if(cleanM && cleanM !== myId) {
                        const check = await getDoc(doc(db, "users", cleanM));
                        if(check.exists()) members.push(cleanM);
                    }
                }
                
                if(members.length < 2) { err.innerText = "Ajoutez au moins un ID valide."; return; }

                await addDoc(collection(db, "groups"), {
                    name: gName,
                    members: members,
                    createdBy: myId,
                    avatar: "https://cdn-icons-png.flaticon.com/512/166/166258.png"
                });
                closeModal();
            };
        }
        else if (type === 'renameGroup') {
            title.innerText = "Renommer le groupe";
            inp1.value = groupsCache[currentChatId].name;
            btn.onclick = async () => {
                const newName = inp1.value.trim();
                if(!newName) return;
                await updateDoc(doc(db, "groups", currentChatId), { name: newName });
                closeModal();
            };
        }
    };

    window.closeModal = () => {
        document.getElementById('modal-overlay').classList.add('hidden');
    };

    // --- LISTE CONTACTS ---
    function getUnreadCount(chatId) {
        const lastRead = parseInt(localStorage.getItem('last_read_' + chatId) || '0');
        return globalMessages.filter(m => {
            const incoming = m.sender !== myId;
            const belongsToChat = m.groupId === chatId || (m.sender === chatId && !m.groupId);
            return belongsToChat && incoming && m.timestamp > lastRead;
        }).length;
    }

    function getLastMessage(chatId, isGroup) {
        return globalMessages.find(m => {
            if(isGroup) return m.groupId === chatId;
            return (m.sender === chatId && m.receiver === myId) || (m.sender === myId && m.receiver === chatId);
        });
    }

    window.renderContactList = () => {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        let items = [];
        const contacts = JSON.parse(localStorage.getItem('tess_contacts') || '{}');

        // Groupes
        for(let gId in groupsCache) items.push({ id: gId, ...groupsCache[gId], type: 'group' });
        // Contacts
        for(let cId in contacts) items.push({ id: cId, ...contacts[cId], type: 'user' });
        // Inconnus
        const senders = new Set(globalMessages.filter(m => !m.groupId && m.sender !== myId).map(m => m.sender));
        senders.forEach(sId => {
            if(!contacts[sId]) items.push({ id: sId, name: sId, type: 'user', isNew: true });
        });

        // D√©duplication + Tri
        items = Array.from(new Map(items.map(item => [item.id, item])).values());
        items.sort((a, b) => {
            const mA = getLastMessage(a.id, a.type === 'group');
            const mB = getLastMessage(b.id, b.type === 'group');
            return (mB ? mB.timestamp : 0) - (mA ? mA.timestamp : 0);
        });

        items.forEach(item => {
            const msg = getLastMessage(item.id, item.type === 'group');
            const unread = getUnreadCount(item.id);
            const avatar = item.type === 'group' ? item.avatar : (usersCache[item.id]?.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png");
            
            let txt = "Aucun message";
            if(msg) txt = (msg.sender === myId ? "Vous: " : "") + (msg.type === 'text' ? msg.text : (msg.type === 'img' ? 'Photo' : 'Vid√©o'));

            const div = document.createElement('div');
            div.className = "contact-item";
            div.onclick = () => openChat(item);
            div.innerHTML = `
                <img src="${avatar}" class="avatar">
                <div class="contact-info">
                    <div class="name">${item.name} ${item.isNew ? '<span class="badge-new">NOUVEAU</span>' : ''}</div>
                    <div class="last-msg ${unread > 0 ? 'unread' : ''}">${txt}</div>
                </div>
                ${unread > 0 ? `<div class="badge-count">${unread}</div>` : ''}
            `;
            list.appendChild(div);
        });
    };

    // --- CHAT LOGIC ---
    window.openChat = (item) => {
        currentChatId = item.id;
        isGroupChat = item.type === 'group';
        
        document.getElementById('view-chat').classList.add('active');
        document.getElementById('chat-title').innerText = item.name;
        document.getElementById('chat-avatar').src = item.type === 'group' ? item.avatar : (usersCache[item.id]?.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png");
        
        // Gestion bouton "Crayon" (Seulement si Groupe + Cr√©ateur)
        const editBtn = document.getElementById('edit-group-btn');
        if(isGroupChat && groupsCache[item.id].createdBy === myId) {
            editBtn.classList.remove('hidden');
        } else {
            editBtn.classList.add('hidden');
        }

        renderMessages();
    };

    window.closeChat = () => {
        document.getElementById('view-chat').classList.remove('active');
        currentChatId = null;
    };

    function renderMessages() {
        const box = document.getElementById('messages');
        box.innerHTML = "";
        const msgs = globalMessages.filter(m => {
            if(isGroupChat) return m.groupId === currentChatId;
            return (m.sender === myId && m.receiver === currentChatId) || (m.sender === currentChatId && m.receiver === myId);
        }).sort((a,b) => a.timestamp - b.timestamp);

        msgs.forEach(m => {
            const isMe = m.sender === myId;
            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'sent' : 'received'}`;
            
            let content = m.type === 'text' ? `<div>${m.text}</div>` : `<${m.type === 'img' ? 'img' : 'video'} src="${m.media}" ${m.type==='video'?'controls':''}></${m.type === 'img' ? 'img' : 'video'}>`;
            let sender = "";
            if(isGroupChat && !isMe) {
                const name = usersCache[m.sender] ? (localStorage.getItem(`contact_${m.sender}`) || m.sender) : m.sender;
                sender = `<div class="sender-name-small">${name}</div>`;
            }

            div.innerHTML = `<div style="display:flex;flex-direction:column;align-items:${isMe?'flex-end':'flex-start'}">${sender}<div class="msg-bubble">${content}</div></div>`;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
        localStorage.setItem('last_read_' + currentChatId, Date.now());
    }

    window.sendMessage = async () => {
        const inp = document.getElementById('msgInput');
        const text = inp.value.trim();
        if(!text) return;
        const data = { sender: myId, text: text, timestamp: Date.now(), type: 'text' };
        if(isGroupChat) data.groupId = currentChatId; else data.receiver = currentChatId;
        inp.value = "";
        await addDoc(collection(db, "messages"), data);
    };

    // --- MEDIA ---
    async function compressImage(base64Str) {
        return new Promise(r => {
            let img = new Image(); img.src = base64Str;
            img.onload = () => {
                let cvs = document.createElement('canvas');
                let sc = 600 / img.width; if(sc>1) sc=1;
                cvs.width = img.width * sc; cvs.height = img.height * sc;
                cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                r(cvs.toDataURL('image/jpeg', 0.6));
            };
        });
    }

    document.getElementById('media-upload').addEventListener('change', e => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = async evt => {
            let d = evt.target.result;
            const type = f.type.startsWith('image') ? 'img' : 'video';
            if(type === 'img') d = await compressImage(d);
            if(d.length > 950000) { alert("Fichier trop lourd"); return; }
            const data = { sender: myId, media: d, type: type, timestamp: Date.now() };
            if(isGroupChat) data.groupId = currentChatId; else data.receiver = currentChatId;
            await addDoc(collection(db, "messages"), data);
        };
        r.readAsDataURL(f);
    });

    document.getElementById('profile-upload').addEventListener('change', e => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = async evt => {
            const d = await compressImage(evt.target.result);
            await updateDoc(doc(db, "users", myId), { avatar: d });
        };
        r.readAsDataURL(f);
    });

    // --- ACTIONS CHAT ---
    window.chatActions = () => {
        if(!currentChatId) return;
        if(confirm("Supprimer cette conversation de votre liste locale ?")) {
            let c = JSON.parse(localStorage.getItem('tess_contacts') || '{}');
            delete c[currentChatId];
            localStorage.setItem('tess_contacts', JSON.stringify(c));
            closeChat();
            renderContactList();
        }
    };
    
    window.filterContacts = (v) => {
        Array.from(document.getElementById('contact-list').children).forEach(c => {
            c.style.display = c.innerText.toLowerCase().includes(v.toLowerCase()) ? 'flex' : 'none';
        });
    };

    init();
</script>
</body>
</html>
